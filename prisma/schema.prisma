generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Waitlist {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  notified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([createdAt])
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  tier      String   @default("free") // "free" | "pro" | "premium"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  portfolios Portfolio[]
  usage      UsageTracking[]

  @@index([email])
  @@index([tier])
}

model UsageTracking {
  id                String   @id @default(cuid())
  userId            String
  tier              String
  chatQueries       Int      @default(0)
  portfolioAnalysis Int      @default(0)
  secFilings        Int      @default(0)
  periodStart       DateTime
  periodEnd         DateTime
  createdAt         DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([periodStart, periodEnd])
}

model Portfolio {
  id              String             @id @default(cuid())
  userId          String
  name            String
  type            String
  initialValue    Float
  targetValue     Float
  borrowedAmount  Float
  marginCallLevel Float
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  checklists      DailyChecklist[]
  theses          InvestmentThesis[]
  stocks          Stock[]

  @@index([userId])
  @@index([type])
}

model Stock {
  id           String    @id @default(cuid())
  portfolioId  String
  symbol       String
  name         String
  shares       Int
  avgPrice     Float
  currentPrice Float?
  actualValue  Float?
  lastUpdated  DateTime  @default(now())
  portfolio    Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@index([portfolioId])
  @@index([symbol])
}

model InvestmentThesis {
  id                 String   @id @default(cuid())
  portfolioId        String
  ticker             String
  title              String
  description        String
  rationale          String
  bearCase           String?
  risks              String[]
  keyMetrics         Json     // Array of ThesisMetric objects
  stopLossRules      Json     // Array of StopLossRule objects
  exitCriteria       Json     // ExitCriteria object
  thesisHealthScore  Float
  urgency            String   // 'green' | 'yellow' | 'red'
  lastValidated      DateTime?
  validationHistory  Json?    // Array of ValidationRecord objects
  status             String   @default("active")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  portfolio          Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@index([portfolioId])
  @@index([status])
  @@index([urgency])
}

model DailyChecklist {
  id                   String          @id @default(cuid())
  portfolioId          String
  date                 DateTime        @default(now())
  totalTasks           Int
  completedTasks       Int             @default(0)
  completionPercentage Float           @default(0)
  currentStreak        Int             @default(0)
  longestStreak        Int             @default(0)
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  tasks                ChecklistTask[]
  portfolio            Portfolio       @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@index([portfolioId])
  @@index([date])
}

model ChecklistTask {
  id          String         @id @default(cuid())
  checklistId String
  portfolioId String
  task        String
  category    String
  frequency   String
  urgency     String
  completed   Boolean        @default(false)
  completedAt DateTime?
  condition   String?
  dueDate     DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  checklist   DailyChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)

  @@index([checklistId])
  @@index([portfolioId])
  @@index([category])
  @@index([completed])
}
