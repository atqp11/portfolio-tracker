generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public", "auth"]
}

model Waitlist {
  id        String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  email     String   @unique
  name      String?
  notified  Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("waitlist")
  @@schema("public")
  @@index([email])
  @@index([createdAt])
}

model User {
  id        String   @id @db.Uuid
  email     String   @unique
  name      String?
  tier      String   @default("free") // "free" | "basic" | "premium"
  isAdmin   Boolean  @default(false) @map("is_admin")

  // Stripe integration fields (for future payment system)
  stripeCustomerId      String? @map("stripe_customer_id")
  stripeSubscriptionId  String? @map("stripe_subscription_id")
  subscriptionStatus    String? @map("subscription_status")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  portfolios Portfolio[]
  usage      UsageTracking[]

  @@map("profiles")
  @@schema("public")
  @@index([email])
  @@index([tier])
  @@index([isAdmin], map: "idx_profiles_is_admin")
}

model UsageTracking {
  id                String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId            String   @map("user_id") @db.Uuid
  tier              String
  chatQueries       Int      @default(0) @map("chat_queries")
  portfolioAnalysis Int      @default(0) @map("portfolio_analysis")
  secFilings        Int      @default(0) @map("sec_filings")
  portfolioChanges  Int      @default(0) @map("portfolio_changes")
  periodStart       DateTime @map("period_start") @db.Timestamptz(6)
  periodEnd         DateTime @map("period_end") @db.Timestamptz(6)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("usage_tracking")
  @@schema("public")
  @@index([userId])
  @@index([periodStart, periodEnd])
}

model Portfolio {
  id              String             @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId          String             @map("user_id") @db.Uuid
  name            String
  type            String
  initialValue    Decimal            @map("initial_value") @db.Decimal(12, 2)
  targetValue     Decimal            @map("target_value") @db.Decimal(12, 2)
  borrowedAmount  Decimal            @default(0) @map("borrowed_amount") @db.Decimal(12, 2)
  marginCallLevel Decimal            @default(0) @map("margin_call_level") @db.Decimal(12, 2)
  createdAt       DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime           @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  checklists      DailyChecklist[]
  theses          InvestmentThesis[]
  stocks          Stock[]

  @@index([userId])
  @@index([type])
  @@map("portfolios")
  @@schema("public")
}

model Stock {
  id           String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  portfolioId  String    @map("portfolio_id")
  symbol       String
  name         String
  shares       Int
  avgPrice     Decimal   @map("avg_price") @db.Decimal(10, 4)
  currentPrice Decimal?  @map("current_price") @db.Decimal(10, 4)
  actualValue  Decimal?  @map("actual_value") @db.Decimal(12, 2)
  lastUpdated  DateTime  @default(now()) @map("last_updated") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  portfolio    Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([portfolioId])
  @@index([symbol])
  @@map("stocks")
  @@schema("public")
}

model InvestmentThesis {
  id                 String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  portfolioId        String    @map("portfolio_id")
  ticker             String
  title              String
  description        String
  rationale          String
  bearCase           String?   @map("bear_case")
  risks              String[]
  keyMetrics         Json      @default("[]") @map("key_metrics")
  stopLossRules      Json      @default("[]") @map("stop_loss_rules")
  exitCriteria       Json      @default("{}") @map("exit_criteria")
  thesisHealthScore  Decimal   @map("thesis_health_score") @db.Decimal(5, 2)
  urgency            String
  lastValidated      DateTime? @map("last_validated") @db.Timestamptz(6)
  validationHistory  Json?     @default("[]") @map("validation_history")
  status             String    @default("active")
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  portfolio          Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([portfolioId])
  @@index([status])
  @@index([urgency])
  @@index([ticker])
  @@map("investment_theses")
  @@schema("public")
}

model DailyChecklist {
  id                   String          @id @default(dbgenerated("(gen_random_uuid())::text"))
  portfolioId          String          @map("portfolio_id")
  date                 DateTime        @default(now()) @db.Timestamptz(6)
  totalTasks           Int             @map("total_tasks")
  completedTasks       Int             @default(0) @map("completed_tasks")
  completionPercentage Decimal         @default(0) @map("completion_percentage") @db.Decimal(5, 2)
  currentStreak        Int             @default(0) @map("current_streak")
  longestStreak        Int             @default(0) @map("longest_streak")
  createdAt            DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime        @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tasks                ChecklistTask[]
  portfolio            Portfolio       @relation(fields: [portfolioId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([portfolioId])
  @@index([date])
  @@map("daily_checklists")
  @@schema("public")
}

model ChecklistTask {
  id          String         @id @default(dbgenerated("(gen_random_uuid())::text"))
  checklistId String         @map("checklist_id")
  portfolioId String         @map("portfolio_id")
  task        String
  category    String
  frequency   String
  urgency     String
  completed   Boolean        @default(false)
  completedAt DateTime?      @map("completed_at") @db.Timestamptz(6)
  condition   String?
  dueDate     DateTime?      @map("due_date") @db.Timestamptz(6)
  createdAt   DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  checklist   DailyChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([checklistId])
  @@index([portfolioId])
  @@index([category])
  @@index([completed])
  @@map("checklist_tasks")
  @@schema("public")
}

// ============================================================================
// L3 Cache Tables (Long-term persistent cache)
// ============================================================================

model CacheFilingSummary {
  ticker         String    @db.VarChar(10)
  filingType     String    @map("filing_type") @db.VarChar(20)
  filingDate     DateTime  @map("filing_date") @db.Date
  summaryText    String    @map("summary_text")
  keyPoints      Json?     @map("key_points")
  sentimentScore Decimal?  @map("sentiment_score") @db.Decimal(3, 2)
  generatedAt    DateTime  @default(now()) @map("generated_at") @db.Timestamptz(6)
  generatedBy    String?   @map("generated_by") @db.VarChar(50)
  dataVersion    Int       @default(1) @map("data_version")
  expiresAt      DateTime? @map("expires_at") @db.Timestamptz(6)

  @@id([ticker, filingType, filingDate])
  @@index([ticker, filingDate(sort: Desc)], map: "idx_filing_summaries_ticker_date")
  @@index([expiresAt], map: "idx_filing_summaries_expires")
  @@map("cache_filing_summaries")
  @@schema("public")
}

model CacheCompanyProfile {
  ticker        String    @id @db.VarChar(10)
  profileData   Json      @map("profile_data")
  updatedAt     DateTime  @default(now()) @map("updated_at") @db.Timestamptz(6)
  dataVersion   Int       @default(1) @map("data_version")
  expiresAt     DateTime  @map("expires_at") @db.Timestamptz(6)
  sourceCount   Int       @map("source_count")
  lastVerified  DateTime? @map("last_verified") @db.Timestamptz(6)

  @@index([expiresAt], map: "idx_company_profiles_expires")
  @@map("cache_company_profiles")
  @@schema("public")
}

model CacheNewsSentiment {
  id             Int      @id @default(autoincrement())
  ticker         String   @db.VarChar(10)
  newsDate       DateTime @map("news_date") @db.Date
  newsUrl        String?  @map("news_url")
  newsTitle      String   @map("news_title")
  sentimentScore Decimal  @map("sentiment_score") @db.Decimal(3, 2)
  sentimentLabel String   @map("sentiment_label") @db.VarChar(20)
  confidence     Decimal? @db.Decimal(3, 2)
  aiSummary      String?  @map("ai_summary")
  keyTopics      Json?    @map("key_topics")
  processedAt    DateTime @default(now()) @map("processed_at") @db.Timestamptz(6)
  processedBy    String?  @map("processed_by") @db.VarChar(50)
  dataVersion    Int      @default(1) @map("data_version")

  @@index([ticker, newsDate(sort: Desc)], map: "idx_news_sentiment_ticker_date")
  @@index([ticker, sentimentScore, newsDate], map: "idx_news_sentiment_score")
  @@unique([ticker, newsDate, newsUrl], map: "idx_news_sentiment_unique")
  @@map("cache_news_sentiment")
  @@schema("public")
}
