generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Waitlist {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  notified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([createdAt])
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  tier      String   @default("free") // "free" | "basic" | "premium"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  portfolios Portfolio[]
  usage      UsageTracking[]

  @@index([email])
  @@index([tier])
}

model UsageTracking {
  id                String   @id @default(cuid())
  userId            String
  tier              String
  chatQueries       Int      @default(0)
  portfolioAnalysis Int      @default(0)
  secFilings        Int      @default(0)
  periodStart       DateTime
  periodEnd         DateTime
  createdAt         DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([periodStart, periodEnd])
}

model Portfolio {
  id              String             @id @default(cuid())
  userId          String             @map("user_id")
  name            String
  type            String
  initialValue    Float              @map("initial_value")
  targetValue     Float              @map("target_value")
  borrowedAmount  Float              @map("borrowed_amount")
  marginCallLevel Float              @map("margin_call_level")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  checklists      DailyChecklist[]
  theses          InvestmentThesis[]
  stocks          Stock[]

  @@index([userId])
  @@index([type])
  @@map("portfolios")
}

model Stock {
  id           String    @id @default(cuid())
  portfolioId  String    @map("portfolio_id")
  symbol       String
  name         String
  shares       Int
  avgPrice     Float     @map("avg_price")
  currentPrice Float?    @map("current_price")
  actualValue  Float?    @map("actual_value")
  lastUpdated  DateTime  @default(now()) @map("last_updated")
  createdAt    DateTime  @default(now()) @map("created_at")
  portfolio    Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@index([portfolioId])
  @@index([symbol])
  @@map("stocks")
}

model InvestmentThesis {
  id                 String   @id @default(cuid())
  portfolioId        String   @map("portfolio_id")
  ticker             String
  title              String
  description        String
  rationale          String
  bearCase           String?  @map("bear_case")
  risks              String[]
  keyMetrics         Json     @map("key_metrics")
  stopLossRules      Json     @map("stop_loss_rules")
  exitCriteria       Json     @map("exit_criteria")
  thesisHealthScore  Float    @map("thesis_health_score")
  urgency            String
  lastValidated      DateTime? @map("last_validated")
  validationHistory  Json?    @map("validation_history")
  status             String   @default("active")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")
  portfolio          Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@index([portfolioId])
  @@index([status])
  @@index([urgency])
  @@map("investment_theses")
}

model DailyChecklist {
  id                   String          @id @default(cuid())
  portfolioId          String          @map("portfolio_id")
  date                 DateTime        @default(now())
  totalTasks           Int             @map("total_tasks")
  completedTasks       Int             @default(0) @map("completed_tasks")
  completionPercentage Float           @default(0) @map("completion_percentage")
  currentStreak        Int             @default(0) @map("current_streak")
  longestStreak        Int             @default(0) @map("longest_streak")
  createdAt            DateTime        @default(now()) @map("created_at")
  updatedAt            DateTime        @updatedAt @map("updated_at")
  tasks                ChecklistTask[]
  portfolio            Portfolio       @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@index([portfolioId])
  @@index([date])
  @@map("daily_checklists")
}

model ChecklistTask {
  id          String         @id @default(cuid())
  checklistId String         @map("checklist_id")
  portfolioId String         @map("portfolio_id")
  task        String
  category    String
  frequency   String
  urgency     String
  completed   Boolean        @default(false)
  completedAt DateTime?      @map("completed_at")
  condition   String?
  dueDate     DateTime?      @map("due_date")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")
  checklist   DailyChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)

  @@index([checklistId])
  @@index([portfolioId])
  @@index([category])
  @@index([completed])
  @@map("checklist_tasks")
}
